import pandas as pd
import json
import os
import math

# ==========================================
# 1. CONFIGURATION
# ==========================================
class Config:
    # Path to the CSV generated by the influence script
    INPUT_CSV = "./influence_scoring_results/influence_comparison.csv"
    
    # Where to save the new training file
    OUTPUT_JSON = "data/if_dpo_train.json"
    
    # Percentage of data to keep (0.3 = Top 30%)
    TOP_PERCENT = 0.30 
    
    # The score column name in the CSV
    SCORE_COL = "score_datainf" 

def main():
    print(f"üìÇ Loading scores from: {Config.INPUT_CSV}")
    
    if not os.path.exists(Config.INPUT_CSV):
        raise FileNotFoundError(f"Could not find {Config.INPUT_CSV}. Did you run the influence script?")

    # 1. Load Data
    df = pd.read_csv(Config.INPUT_CSV)
    total_samples = len(df)
    
    # 2. Sort by Score (Descending = Highest Influence First)
    # Higher score = More helpful for the validation set
    df_sorted = df.sort_values(by=Config.SCORE_COL, ascending=False)
    
    # 3. Calculate Cutoff
    keep_count = math.ceil(total_samples * Config.TOP_PERCENT)
    print(f"üìä Total Samples: {total_samples}")
    print(f"‚úÇÔ∏è  Selection Rate: {Config.TOP_PERCENT*100}%")
    print(f"‚úÖ Keeping Top:   {keep_count} samples")
    
    # 4. Slice the Dataset
    df_selected = df_sorted.head(keep_count)
    
    # 5. Convert to DPO JSON Format
    # We ensure 'input' exists (often empty for chat/instruct models)
    if "input" not in df_selected.columns:
        df_selected["input"] = ""

    # Select only necessary columns
    # Note: 'instruction' maps to 'prompt' in some trainers, keeping standard keys here.
    final_data = []
    for _, row in df_selected.iterrows():
        entry = {
            "instruction": row["instruction"],
            "input": row.get("input", ""),
            "chosen": row["chosen"],
            "rejected": row["rejected"]
        }
        final_data.append(entry)

    # 6. Save
    os.makedirs(os.path.dirname(Config.OUTPUT_JSON), exist_ok=True)
    
    with open(Config.OUTPUT_JSON, "w", encoding="utf-8") as f:
        json.dump(final_data, f, indent=2, ensure_ascii=False)
        
    print(f"\nüíæ Saved high-quality dataset to: {Config.OUTPUT_JSON}")
    
    # 7. Print Stats (Sanity Check)
    avg_score_selected = df_selected[Config.SCORE_COL].mean()
    avg_score_all = df[Config.SCORE_COL].mean()
    
    print("\n--- Statistics ---")
    print(f"Average Score (All Data):      {avg_score_all:.4f}")
    print(f"Average Score (Selected Top):  {avg_score_selected:.4f}")
    print("------------------")
    print("Example Entry:")
    print(json.dumps(final_data[0], indent=2))

if __name__ == "__main__":
    main()